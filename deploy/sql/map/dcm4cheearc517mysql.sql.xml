<?xml version="1.0" encoding="UTF-8"?>
<plist
 xmlns="http://www.opendicom.com/xsd/plist/sql.xsd"
        
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://www.opendicom.com/xsd/plist/sql.xsd sql.xsd"
        
 version="1.0"
>
<dict>
        
 <key>sqlTitle</key>
 <string>dcm4cheearc517mysql</string>

 <!-- E select -->
 <key>EselectEP</key>
 <string>SELECT study.pk, study.patient_fk FROM study </string>
 <key>EselectEuiE</key>
 <string>SELECT study.study_iuid, study.pk FROM study </string>
 
 <key>Ewhere</key>
 <string>WHERE study.rejection_state!=2 </string>
 
 
 <!-- E exclusive match--> 
 <!-- 1. match study UID -->
 <key>EmatchEui</key>
 <string>AND study.study_iuid REGEXP '%@' </string>
 <!-- 2. match accession number [0, 1 entity_id, 2 entity_uid + type, 3 entity_uid + type + entity_id]-->
 <key>EmatchEan</key>
 <array>  
  <string>AND study.accession_no='%@' </string>
  <string>AND study.accession_no='%@' AND issuer.entity_id='@%' </string>
  <string>AND study.accession_no='%@' AND issuer.entity_uid='@%' AND issuer.entity_uid_type='@%' </string>
  <string>AND study.accession_no='%@' AND issuer.entity_uid='@%' AND issuer.entity_uid_type='@%' AND issuer.entity_id='@%' </string>
 </array>
 
 <!-- E cumulative matches-->

 <key>Ejoin</key>
 <array>
  <!-- 0. accessionNumberIssuer -->
  <array>
   <string>LEFT JOIN issuer ON study.accno_issuer_fk=issuer.pk </string>
  </array>
  <!-- 1. match PID [0, 1 issuer] -->
  <array>
   <string>LEFT JOIN patient ON study.patient_fk=patient.pk </string>
   <string>LEFT JOIN patient_id ON patient.patient_id_fk=patient_id.pk </string>
   <string>LEFT JOIN issuer ON patient_id.issuer_fk=issuer.pk </string>
  </array>
  <!-- 2. match PatientName -->
  <array>
   <string>LEFT JOIN patient ON study.patient_fk=patient.pk </string>
   <string>LEFT JOIN person_name Ppn ON patient.pat_name_fk=Ppn.pk </string>
  </array>
  <!-- 3. match StudyID -->
  <array/>
  <!-- 4. match StudyDate -->
  <array/>
  <!-- 5. match StudyDescription -->
  <array/>
  <!-- 6. match ReferringPhysician -->
  <array>
   <string>LEFT JOIN person_name Epn ON study.ref_phys_name_fk=Epn.pk </string>
  </array>
  <!-- 7. match ReadingPhysician -->
  <array/>
  <!-- 8. match SOPClassesInStudy -->
  <array>
   <string>LEFT JOIN study_query_attrs ON study.pk=study_query_attrs.study_pk </string>
  </array>
  <!-- 9. match ModalitiesInStudy -->    
  <array>
   <string>LEFT JOIN study_query_attrs ON study.pk=study_query_attrs.study_pk </string>
  </array>
 </array>
  
 <key>Eand</key> 
 <array>
  <array/>
  <!-- 1. match PID [0, 1 issuer] -->
  <array>
   <string>AND patient_id.pat_id like '%@' </string>
   <string>AND patient_id.pat_id like '%@' AND issuer.entity_id = '%@' </string>
  </array>
  <!-- 2. match PatientName -->
  <array>
   <string></string>
   <string>AND Ppn.family_name LIKE '%@' </string>
   <string>AND Ppn.given_name LIKE '%@' </string>
   <string>AND Ppn.middle_name LIKE '%@' </string>
   <string>AND PPn.name_prefix LIKE '%@' </string>
   <string>AND Ppn.name_suffix LIKE '%@' </string>
  </array>
  <!-- 3. match StudyID -->
  <string>AND  study_id like '%@' </string>
  <!-- 4. match StudyDate-->
  <array>
    <array/><!-- ISO in DB-->
    <array><!-- DICOM DA in DB-->
        <string></string> <!-- (empty) = any -->
        <string>AND study.study_date = '%@' </string> <!-- [aaaa-mm-dd] = on -->
        <string>AND study.study_date >= '%@' </string><!-- [aaaa-mm-dd][] = since -->
        <string>AND NOT(study.study_date > '%@') </string><!-- [][][aaaa-mm-dd] = until -->
        <string>AND study.study_date >= '%@' AND NOT(study.study_date > '%@') </string><!-- [aaaa-mm-dd][][][aaaa-mm-dd] = between -->
    </array>
  </array>
  <!-- 5. match StudyDescription -->
  <string>AND study.study_desc REGEXP '%@' </string>
  <!-- 6. match ReferringPhysician -->
  <array>
   <string></string>
   <string>AND Epn.family_name LIKE '%@' </string>
   <string>AND Epn.given_name LIKE '%@' </string>
   <string>AND Epn.middle_name LIKE '%@' </string>
   <string>AND EPn.name_prefix LIKE '%@' </string>
   <string>AND Epn.name_suffix LIKE '%@' </string>
  </array>        
  <!-- 7. match ReadingPhysician -->
  <array>
   <string>AND study.study_custom3 REGEXP '%@' </string>
   <string>%@ </string>
   <string>%@ </string>
   <string>%@ </string>
   <string>%@ </string>
   <string>%@ </string>
  </array>                
  <!-- 8. match SOPClassesInStudy -->
  <string>AND study_query_attrs.cuids_in_study REGEXP '%@' </string>
  <!-- 9. match ModalitiesInStudy -->
  <string>AND study_query_attrs.mods_in_study REGEXP '%@' </string>
 </array>

<!-- end of E cumulative matches-->
 
 
 
<!-- instance ci 4 series pk -->
<!-- check on series rejection state already performed at series level --> 
<key>Ici4S</key>
<string>%@ "SELECT sop_cuid FROM instance WHERE series_fk='%@' %@" %@ </string>
              
<!-- instance ui 4 series pk -->
<key>Iui4S</key>
<string>%@ "SELECT sop_iuid FROM instance WHERE series_fk='%@' %@" %@ </string>

 
        
<!-- properties (check on series rejection state already performed at study and series level selection) -->       
<key>P</key><!-- patient -->
<string>%@ "\
SELECT \
patient.pk, \
patient_id.pat_id, \
CONCAT(IFNULL(person_name.family_name,''), '^', IFNULL(person_name.given_name,''), '^', IFNULL(person_name.middle_name,''), '^', IFNULL(person_name.name_prefix,''), '^', IFNULL(person_name.name_suffix,'')), \
issuer.entity_id, \
patient.pat_birthdate, \
patient.pat_sex \
FROM patient \
LEFT JOIN person_name ON patient.pat_name_fk=person_name.pk \
LEFT JOIN patient_id ON patient.patient_id_fk=patient_id.pk \
LEFT JOIN issuer ON patient_id.issuer_fk=issuer.pk \
WHERE patient.pk=%@ \
%@ \
" %@ </string>
 
<key>E</key><!-- examen -->
<string>%@ "\
SELECT \
study.pk, \
study.study_iuid, \
study.study_desc, \
study.study_date, \
study.study_time, \
study.accession_no, \
study.study_id, \
CONCAT(IFNULL(person_name.family_name,''), '^', IFNULL(person_name.given_name,''), '^', IFNULL(person_name.middle_name,''), '^', IFNULL(person_name.name_prefix,''), '^', IFNULL(person_name.name_suffix,'')), \
study.study_custom3, \
study_query_attrs.num_series, \
study_query_attrs.mods_in_study, \
study.study_custom1, \
study.study_custom2, \
study.study_custom3, \
issuer.entity_id, \
issuer.entity_uid, \
issuer.entity_uid_type \
FROM study \
LEFT JOIN study_query_attrs ON study_query_attrs.study_fk=study.pk \
LEFT JOIN person_name ON study.ref_phys_name_fk=person_name.pk \
LEFT JOIN issuer ON study.accno_issuer_fk=issuer.pk \
WHERE study.pk=%@ \
AND study_query_attrs.view_id='regularUse' \
%@ \
" %@ </string>

<key>S</key><!-- serie -->
<string>%@ "\
SELECT \
series.pk, \
series.series_iuid, \
series.series_desc, \
series.series_no, \
series.modality, \
series.institution, \
series.department, \
series.station_name, \
CONCAT(IFNULL(person_name.family_name,''), '^', IFNULL(person_name.given_name,''), '^', IFNULL(person_name.middle_name,''), '^', IFNULL(person_name.name_prefix,''), '^', IFNULL(person_name.name_suffix,'')), \
series.laterality, \
series_query_attrs.num_instances, \
series.pps_start_date, \
series.pps_start_time \
FROM series \
LEFT JOIN person_name ON series.perf_phys_name_fk=person_name.pk \
LEFT JOIN series_query_attrs ON series.pk=series_query_attrs.series_fk \
WHERE series.study_fk=%@ \
AND series_query_attrs.view_id='regularUse' \
%@ \
" %@ </string>

<key>I0</key><!-- instance of no frame object-->
<string>%@ "\
SELECT \
pk, \
sop_cuid, \
sop_iuid, \
inst_no, \
0 \
FROM instance \
WHERE series_fk='%@' \
%@ \
%@ \
%@ \
" %@ </string>

<key>I1</key><!-- instance of unique frame object -->
<string>%@ "\
SELECT \
pk, \
sop_cuid, \
sop_iuid, \
inst_no, \
1 \
FROM instance \
WHERE series_fk='%@' \
%@ \
%@ \
%@ \
" %@ </string>
 
<key>I</key><!-- instance -->
<string>%@ "\
SELECT \
pk, \
sop_cuid, \
sop_iuid, \
inst_no, \
num_frames \
FROM instance \
WHERE series_fk='%@' \
%@ \
%@ \
%@ \
" %@ </string>

 <key>ANDinstanceSOPClass</key>
 <string>AND sop_cuid  REGEXP '%@'</string>

 <key>ANDinstanceSOPClassOff</key>
 <string>AND NOT(sop_cuid  REGEXP '%@')</string>

<key>IpostprocessingCommandsSh</key><!-- if empty, default array  -->
<string></string>

<key>IpostprocessingTitleMain</key>
<string></string>

<key>RE</key><!-- Report EKey -->
<string>%@ "\
SELECT \
study.study_iuid, \
series.series_iuid, \
instance.sopiuid, \
FROM instance \
LEFT JOIN series ON series.pk=instance.series_fk
LEFT JOIN study ON study.pk=series.study_fk
WHERE study.pk='%@' \
AND series.modality='%@' \
AND study.rejection_state!=2 \
AND series.rejection_state!=2 \
AND instance.sop_cuid='1.2.840.10008.5.1.4.1.1.104.2' \
ORDER BY instance.created_time DESC \
LIMIT 1; \
" %@ </string>

<key>RU</key><!-- Report StudyInstanceUID -->
<string>%@ "\
SELECT \
study.study_iuid, \
series.series_iuid, \
instance.sopiuid, \
FROM instance \
LEFT JOIN series ON series.pk=instance.series_fk
LEFT JOIN study ON study.pk=series.study_fk
WHERE study.study_iuid='%@' \
AND series.modality='%@' \
AND study.rejection_state!=2 \
AND series.rejection_state!=2 \
AND instance.sop_cuid='1.2.840.10008.5.1.4.1.1.104.2' \
ORDER BY instance.created_time DESC \
LIMIT 1; \
" %@ </string>

<key>RA</key><!-- Report AccessionNumber -->
<string>%@ "\
SELECT \
study.study_iuid, \
series.series_iuid, \
instance.sopiuid, \
FROM instance \
LEFT JOIN series ON series.pk=instance.series_fk
LEFT JOIN study ON study.pk=series.study_fk
WHERE study.accession_no='%@' \
AND series.modality='%@' \
AND study.rejection_state!=2 \
AND series.rejection_state!=2 \
AND instance.sop_cuid='1.2.840.10008.5.1.4.1.1.104.2' \
ORDER BY instance.created_time DESC \
LIMIT 1; \
" %@ </string>

 
</dict>

</plist>
