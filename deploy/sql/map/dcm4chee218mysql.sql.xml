<?xml version="1.0" encoding="UTF-8"?>
<plist
    xmlns="http://www.opendicom.com/xsd/plist/sql.xsd"
    
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.opendicom.com/xsd/plist/sql.xsd sql.xsd"
    
    version="1.0"
    >
    <dict>
               
        <key>sqlTitle</key>
        <string>dcm4chee218mysql</string>

        <!-- E select -->
        <key>EselectEP</key>
        <string>SELECT study.pk, study.patient_fk FROM study </string>
        <key>EselectEuiE</key>
        <string>SELECT study.study_iuid, study.pk FROM study </string>
         
        <key>Ewhere</key>
        <string>WHERE true </string>
        
<!-- E exclusive match--> 
<!-- 1. match study UID -->
<key>EmatchEui</key>
<string>AND study.study_iuid REGEXP '%@' </string>
<!-- 2. match accession number [0, 1 entity_id, 2 entity_uid + type, 3 entity_uid + type + entity_id]-->
<key>EmatchEan</key>
<array>  
    <string>AND study.accession_no='%@' </string>
    <string>AND study.accession_no='%@' AND issuer.entity_id='@%' </string>
    <string>AND study.accession_no='%@' AND issuer.entity_uid='@%' AND issuer.entity_uid_type='@%' </string>
    <string>AND study.accession_no='%@' AND issuer.entity_uid='@%' AND issuer.entity_uid_type='@%' AND issuer.entity_id='@%' </string>
</array>


<!-- E cumulative matches-->

<key>Ejoin</key>
<array>
    <!-- 0. accessionNumberIssuer -->
    <array>
        <string>LEFT JOIN issuer ON study.accno_issuer_fk=issuer.pk </string>
    </array>
    <!-- 1. PID -->
    <array>
        <string>LEFT JOIN patient ON study.patient_fk=patient.pk </string>
    </array>
    <!-- 2. PatientName -->
    <array>
        <string>LEFT JOIN patient ON study.patient_fk=patient.pk </string>
    </array>
    <!-- 3. match StudyID -->
    <array/>
    <!-- 4. match StudyDate -->
    <array/>
    <!-- 5. match StudyDescription -->
    <array/>
    <!-- 6. match ReferringPhysician -->
    <array/>
    <!-- 7. match ReadingPhysician -->
    <array/>
    <!-- 8. match SOPClassesInStudy -->
    <array/>
    <!-- 9. match ModalitiesInStudy -->    
    <array/>
</array>
        
        
<key>Eand</key> 
<array>
    <array/>
    <!-- 1. match PID [0, 1 issuer] -->
    <array>
        <string>AND patient.pat_id like '%@' </string>
        <string>AND patient.pat_id like '%@' AND patient.pat_id_issuer = '%@' </string>
    </array>
    <!-- 2. match PatientName -->
    <array>
        <string>AND patient.pat_name REGEXP '%@' </string>
        <string/>
        <string/>
        <string/>
        <string/>
        <string/>
    </array>
    <!-- 3. match StudyID -->
    <string>AND  study_id like '%@' </string>
    <!-- 4. match StudyDate -->
    <array>
        <string></string> <!-- (empty) = any -->
        <string>AND DATE(study.study_datetime) = '%@' </string> <!-- [aaaa-mm-dd] = on -->
        <string>AND DATE(study.study_datetime) >= '%@' </string><!-- [aaaa-mm-dd][] = since -->
        <string>AND NOT(DATE(study.study_datetime) > '%@') </string><!-- [][][aaaa-mm-dd] = until -->
        <string>AND DATE(study.study_datetime) >= '%@' AND NOT(DATE(study.study_datetime) > '%@') </string><!-- [aaaa-mm-dd][][][aaaa-mm-dd] = between -->
    </array>
    <!-- 5. match StudyDescription -->
    <string>AND study.study_desc REGEXP '%@' </string>
    <!-- 6. match ReferringPhysician -->
    <array>
        <string>AND study.ref_physician REGEXP '%@' </string>
        <string/>
        <string/>
        <string/>
        <string/>
        <string/>
    </array>        
    <!-- 7. match ReadingPhysician -->
    <array>
        <string>AND study.study_custom3 REGEXP '%@' </string>
        <string>%@ </string>
        <string>%@ </string>
        <string>%@ </string>
        <string>%@ </string>
        <string>%@ </string>
    </array>                
    <!-- 8. match SOPClassesInStudy -->
    <string>AND study.cuids_in_study REGEXP '%@' </string>
    <!-- 9. match ModalitiesInStudy -->    
    <string>AND study.mods_in_study REGEXP '%@' </string>
</array>

<!-- end of E cumulative matches-->


       <!-- instance ci 4 series pk -->
       <key>Ici4S</key>
       <string>%@SELECT sop_cuid FROM instance WHERE series_fk='%@' %@ %@</string>
              
       <!-- instance ui 4 series pk -->
       <key>Iui4S</key>
       <string>%@SELECT sop_iuid FROM instance WHERE series_fk='%@' %@ %@</string>

      
        
<!-- properties-->
<key>P</key><!-- patient -->
<string>%@ \
SELECT \
patient.pk, \
patient.pat_id, \
patient.pat_name, \
patient.pat_id_issuer, \
patient.pat_birthdate, \
patient.pat_sex \
FROM patient \
WHERE pk=%@ \
%@ %@ </string>
<key>E</key><!-- examen -->
<string>%@ \
SELECT \
pk, \
study_iuid, \
study_desc, \
DATE(study_datetime), \
TIME(study_datetime), \
accession_no, \
study_id, \
ref_physician, \
study_custom3, \
num_series, \
mods_in_study \
FROM study \
WHERE pk=%@ \
%@ %@ </string>
<key>S</key><!-- serie -->
<string>%@ \
SELECT pk,series_iuid,series_desc,series_no,modality,institution,department,station_name,perf_physician,laterality FROM series WHERE study_fk=%@ %@ %@</string>
<key>I0</key><!-- instance of no frame object-->
<string>%@\
SELECT \
pk, \
sop_iuid, \
inst_no, \
0 \
FROM instance \
WHERE series_fk='%@' \
%@ %@ </string>

<key>I1</key><!-- instance of unique frame object -->
<string>%@\
SELECT \
pk, \
sop_iuid, \
inst_no, \
1 \
FROM instance \
WHERE series_fk='%@' \
%@ %@ </string>

<key>I</key><!-- instance -->
<string>%@\
SELECT \
pk, \
sop_iuid, \
inst_no, \
num_frames \
FROM instance \
WHERE series_fk='%@' \
%@ %@ </string>


<key>IpostprocessingCommandsSh</key><!-- if empty, default array  -->      
<string>" | awk ' BEGIN{ ORS="\x1E\x0A"; OFS="\x1F\x7C";}{print $1, $2, $3, $4, $5}' | sed -e 's/080005004353.*280008004953....//' | sed -e 's/280010005553.*$//' | sed -e 's/20$//'</string>

<key>IpostprocessingTitleMain</key>      
<string>lastTextUnitHEX2ASCII</string>

</dict>

</plist>
